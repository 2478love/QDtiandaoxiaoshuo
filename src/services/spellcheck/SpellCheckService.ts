// 错别字检查服务
export interface SpellError {
  id: string;
  type: 'typo' | 'grammar' | 'punctuation';
  position: {
    start: number;
    end: number;
    length: number;
  };
  original: string;
  suggestions: string[];
  message?: string;
}

export class SpellCheckService {
  // 常见错别字词典
  private static typoDict: Map<string, string[]> = new Map([
    // 的地得混淆
    ['的确', ['的确']],
    ['地方', ['地方']],
    ['得到', ['得到']],
    
    // 在再混淆
    ['在于', ['在于']],
    ['再次', ['再次']],
    ['现在', ['现在']],
    ['再见', ['再见']],
    
    // 常见错别字
    ['按装', ['安装']],
    ['暗然', ['黯然']],
    ['苍桑', ['沧桑']],
    ['常年累月', ['长年累月']],
    ['陈词烂调', ['陈词滥调']],
    ['出奇不意', ['出其不意']],
    ['川流不息', ['川流不息']],
    ['穿流不息', ['川流不息']],
    ['大显神通', ['大显神通']],
    ['大显身手', ['大显身手']],
    ['淡泊明志', ['淡泊明志']],
    ['当仁不让', ['当仁不让']],
    ['道貌暗然', ['道貌岸然']],
    ['低声细语', ['低声细语']],
    ['掉以轻心', ['掉以轻心']],
    ['迭挫强敌', ['迭挫强敌']],
    ['顶力相助', ['鼎力相助']],
    ['度过难关', ['渡过难关']],
    ['防患未燃', ['防患未然']],
    ['飞扬拔扈', ['飞扬跋扈']],
    ['分道扬镖', ['分道扬镳']],
    ['奋发图强', ['奋发图强']],
    ['风尘扑扑', ['风尘仆仆']],
    ['蜂涌而至', ['蜂拥而至']],
    ['浮想联篇', ['浮想联翩']],
    ['甘败下风', ['甘拜下风']],
    ['甘之如怡', ['甘之如饴']],
    ['各行其事', ['各行其是']],
    ['攻城掠地', ['攻城略地']],
    ['鬼斧神功', ['鬼斧神工']],
    ['汗流夹背', ['汗流浃背']],
    ['好高鹜远', ['好高骛远']],
    ['和霭可亲', ['和蔼可亲']],
    ['轰堂大笑', ['哄堂大笑']],
    ['候门似海', ['侯门似海']],
    ['换然一新', ['焕然一新']],
    ['黄梁美梦', ['黄粱美梦']],
    ['挥汗如雨', ['挥汗如雨']],
    ['既往不究', ['既往不咎']],
    ['加官进爵', ['加官晋爵']],
    ['坚如盘石', ['坚如磐石']],
    ['见义勇为', ['见义勇为']],
    ['娇揉造作', ['矫揉造作']],
    ['接踵而至', ['接踵而至']],
    ['竭泽而鱼', ['竭泽而渔']],
    ['金榜提名', ['金榜题名']],
    ['精兵减政', ['精兵简政']],
    ['精神焕散', ['精神涣散']],
    ['精益求精', ['精益求精']],
    ['居安思危', ['居安思危']],
    ['绝无仅有', ['绝无仅有']],
    ['开诚布公', ['开诚布公']],
    ['刻不容缓', ['刻不容缓']],
    ['口干舌燥', ['口干舌燥']],
    ['苦心孤诣', ['苦心孤诣']],
    ['滥芋充数', ['滥竽充数']],
    ['老声常谈', ['老生常谈']],
    ['厉兵秣马', ['厉兵秣马']],
    ['历尽苍桑', ['历尽沧桑']],
    ['励精图治', ['励精图治']],
    ['利令智昏', ['利令智昏']],
    ['两全齐美', ['两全其美']],
    ['了如指掌', ['了如指掌']],
    ['另辟蹊径', ['另辟蹊径']],
    ['流言非语', ['流言蜚语']],
    ['流芳百世', ['流芳百世']],
    ['龙盘虎据', ['龙盘虎踞']],
    ['漏洞百出', ['漏洞百出']],
    ['屡见不鲜', ['屡见不鲜']],
    ['美仑美奂', ['美轮美奂']],
    ['名列前矛', ['名列前茅']],
    ['明火执杖', ['明火执仗']],
    ['莫明其妙', ['莫名其妙']],
    ['墨守陈规', ['墨守成规']],
    ['默守成规', ['墨守成规']],
    ['漠不关心', ['漠不关心']],
    ['目不暇接', ['目不暇接']],
    ['目光如聚', ['目光如炬']],
    ['难辞其咎', ['难辞其咎']],
    ['呕心沥血', ['呕心沥血']],
    ['旁证博引', ['旁征博引']],
    ['迫不急待', ['迫不及待']],
    ['破斧沉舟', ['破釜沉舟']],
    ['其貌不扬', ['其貌不扬']],
    ['气慨非凡', ['气概非凡']],
    ['气势凶凶', ['气势汹汹']],
    ['千均一发', ['千钧一发']],
    ['千里迢迢', ['千里迢迢']],
    ['前扑后继', ['前仆后继']],
    ['强驽之末', ['强弩之末']],
    ['轻歌慢舞', ['轻歌曼舞']],
    ['情不自尽', ['情不自禁']],
    ['磬竹难书', ['罄竹难书']],
    ['趋之若骛', ['趋之若鹜']],
    ['曲意逢迎', ['曲意逢迎']],
    ['全神灌注', ['全神贯注']],
    ['人才倍出', ['人才辈出']],
    ['人情事故', ['人情世故']],
    ['忍辱负重', ['忍辱负重']],
    ['如法泡制', ['如法炮制']],
    ['如火如茶', ['如火如荼']],
    ['如雷灌耳', ['如雷贯耳']],
    ['入不付出', ['入不敷出']],
    ['弱不经风', ['弱不禁风']],
    ['三翻五次', ['三番五次']],
    ['杀一敬百', ['杀一儆百']],
    ['山青水秀', ['山清水秀']],
    ['赏心悦目', ['赏心悦目']],
    ['舍生取义', ['舍生取义']],
    ['身体力行', ['身体力行']],
    ['深恶痛疾', ['深恶痛绝']],
    ['神彩奕奕', ['神采奕奕']],
    ['神智不清', ['神志不清']],
    ['生灵涂碳', ['生灵涂炭']],
    ['盛气凌人', ['盛气凌人']],
    ['世外桃园', ['世外桃源']],
    ['势不可挡', ['势不可当']],
    ['首曲一指', ['首屈一指']],
    ['守株待兔', ['守株待兔']],
    ['水乳交溶', ['水乳交融']],
    ['水泻不通', ['水泄不通']],
    ['顺理成章', ['顺理成章']],
    ['死皮癞脸', ['死皮赖脸']],
    ['肆无忌惮', ['肆无忌惮']],
    ['素昧平生', ['素昧平生']],
    ['随声附合', ['随声附和']],
    ['所向披糜', ['所向披靡']],
    ['谈笑风声', ['谈笑风生']],
    ['叹为观止', ['叹为观止']],
    ['韬光养晦', ['韬光养晦']],
    ['提心掉胆', ['提心吊胆']],
    ['天翻地复', ['天翻地覆']],
    ['天经地仪', ['天经地义']],
    ['天伦之乐', ['天伦之乐']],
    ['挺而走险', ['铤而走险']],
    ['通货膨涨', ['通货膨胀']],
    ['痛心疾首', ['痛心疾首']],
    ['投机倒把', ['投机倒把']],
    ['徒有虚名', ['徒有虚名']],
    ['推心至腹', ['推心置腹']],
    ['脱颖而出', ['脱颖而出']],
    ['完壁归赵', ['完璧归赵']],
    ['玩世不恭', ['玩世不恭']],
    ['万事具备', ['万事俱备']],
    ['妄费心机', ['枉费心机']],
    ['妄自菲薄', ['妄自菲薄']],
    ['危如垒卵', ['危如累卵']],
    ['委屈求全', ['委曲求全']],
    ['蔚然成风', ['蔚然成风']],
    ['温故知新', ['温故知新']],
    ['文过是非', ['文过饰非']],
    ['闻名遐尔', ['闻名遐迩']],
    ['问心无愧', ['问心无愧']],
    ['无耻滥言', ['无耻谰言']],
    ['无精打彩', ['无精打采']],
    ['无可非议', ['无可非议']],
    ['无事生非', ['无事生非']],
    ['无微不致', ['无微不至']],
    ['无与论比', ['无与伦比']],
    ['五彩斑烂', ['五彩斑斓']],
    ['五体头地', ['五体投地']],
    ['息事宁人', ['息事宁人']],
    ['喜出往外', ['喜出望外']],
    ['喜笑颜开', ['喜笑颜开']],
    ['瑕不掩玉', ['瑕不掩瑜']],
    ['闲情逸志', ['闲情逸致']],
    ['相辅相成', ['相辅相成']],
    ['相形见拙', ['相形见绌']],
    ['想入非非', ['想入非非']],
    ['消声匿迹', ['销声匿迹']],
    ['心安理得', ['心安理得']],
    ['心驰神往', ['心驰神往']],
    ['心劳日拙', ['心劳日绌']],
    ['心灰意懒', ['心灰意冷']],
    ['欣欣向荣', ['欣欣向荣']],
    ['星罗其布', ['星罗棋布']],
    ['形迹可疑', ['形迹可疑']],
    ['凶神恶煞', ['凶神恶煞']],
    ['胸有成竹', ['胸有成竹']],
    ['虚座以待', ['虚左以待']],
    ['悬梁刺骨', ['悬梁刺股']],
    ['悬崖勒马', ['悬崖勒马']],
    ['学以至用', ['学以致用']],
    ['循私舞弊', ['徇私舞弊']],
    ['徇情枉法', ['徇情枉法']],
    ['鸦鹊无声', ['鸦雀无声']],
    ['严惩不贷', ['严惩不贷']],
    ['言简意骇', ['言简意赅']],
    ['掩耳盗铃', ['掩耳盗铃']],
    ['眼花潦乱', ['眼花缭乱']],
    ['仰扬顿挫', ['抑扬顿挫']],
    ['杳无音讯', ['杳无音信']],
    ['夜朗自大', ['夜郎自大']],
    ['一愁莫展', ['一筹莫展']],
    ['一如继往', ['一如既往']],
    ['一泄千里', ['一泻千里']],
    ['一言既出', ['一言既出']],
    ['一张一驰', ['一张一弛']],
    ['依然故我', ['依然故我']],
    ['以逸代劳', ['以逸待劳']],
    ['义不容辞', ['义不容辞']],
    ['义无返顾', ['义无反顾']],
    ['异曲同功', ['异曲同工']],
    ['因地治宜', ['因地制宜']],
    ['饮鸠止渴', ['饮鸩止渴']],
    ['应接不暇', ['应接不暇']],
    ['英雄倍出', ['英雄辈出']],
    ['蝇营狗苟', ['蝇营狗苟']],
    ['用心良苦', ['用心良苦']],
    ['忧心重重', ['忧心忡忡']],
    ['有持无恐', ['有恃无恐']],
    ['有条不紊', ['有条不紊']],
    ['与日具增', ['与日俱增']],
    ['语无论次', ['语无伦次']],
    ['原形必露', ['原形毕露']],
    ['再接再励', ['再接再厉']],
    ['责无旁代', ['责无旁贷']],
    ['仗义直言', ['仗义执言']],
    ['招之即来', ['招之即来']],
    ['真知卓见', ['真知灼见']],
    ['振聋发聩', ['振聋发聩']],
    ['正襟危坐', ['正襟危坐']],
    ['直接了当', ['直截了当']],
    ['直言不诲', ['直言不讳']],
    ['指手划脚', ['指手画脚']],
    ['至高无尚', ['至高无上']],
    ['中流抵柱', ['中流砥柱']],
    ['众口烁金', ['众口铄金']],
    ['众目睽睽', ['众目睽睽']],
    ['重蹈复辙', ['重蹈覆辙']],
    ['装黄作样', ['装腔作势']],
    ['追朔既往', ['追溯既往']],
    ['自曝自弃', ['自暴自弃']],
    ['自立更生', ['自力更生']],
    ['自鸣得意', ['自鸣得意']],
    ['走头无路', ['走投无路']],
    ['走为上策', ['走为上策']],
    ['左右逢原', ['左右逢源']],
  ]);

  // 实时检查文本
  static checkText(text: string): SpellError[] {
    const errors: SpellError[] = [];
    let errorId = 0;

    // 检查错别字
    this.typoDict.forEach((suggestions, wrong) => {
      const regex = new RegExp(wrong, 'g');
      let match;
      while ((match = regex.exec(text)) !== null) {
        errors.push({
          id: `error-${errorId++}`,
          type: 'typo',
          position: {
            start: match.index,
            end: match.index + wrong.length,
            length: wrong.length
          },
          original: wrong,
          suggestions: suggestions,
          message: `可能的错别字，建议改为：${suggestions.join('、')}`
        });
      }
    });

    return errors;
  }

  // 应用修正建议
  static applySuggestion(text: string, error: SpellError, suggestionIndex: number = 0): string {
    const { position, suggestions } = error;
    const suggestion = suggestions[suggestionIndex];
    
    return text.substring(0, position.start) + 
           suggestion + 
           text.substring(position.end);
  }

  // 批量修正所有错误
  static autoFixAll(text: string, errors: SpellError[]): string {
    // 按位置倒序排序，从后往前修正，避免位置偏移
    const sortedErrors = [...errors].sort((a, b) => b.position.start - a.position.start);
    
    let result = text;
    for (const error of sortedErrors) {
      if (error.suggestions.length > 0) {
        result = this.applySuggestion(result, error, 0);
      }
    }
    
    return result;
  }
}
